import "math"

rule APK_Dynamic_Code_Loading {
    meta:
        description = "Dynamic Dex loading / reflection (very common in Android malware)"
        severity = "high"
        category = "apk"
    strings:
        $d1 = "dalvik.system.DexClassLoader" ascii
        $d2 = "dalvik.system.PathClassLoader" ascii
        $d3 = "DexFile.loadDex" ascii
        $d4 = "Class.forName(" ascii
        $d5 = "defineClass" ascii
        $d6 = "loadClass(" ascii
    condition:
        any of them
}

rule APK_Native_Code_Abuse {
    meta:
        description = "Native libraries and potential privilege abuse"
        severity = "high"
        category = "apk"
    strings:
        $n1 = "lib/armeabi" ascii
        $n2 = "lib/armeabi-v7a" ascii
        $n3 = "lib/arm64-v8a" ascii
        $n4 = ".so" ascii
        $n5 = "/system/bin/su" ascii
        $n6 = "/system/xbin/su" ascii
        $n7 = "busybox" ascii
    condition:
        any of them
}

rule APK_Suspicious_Network_IO {
    meta:
        description = "Hardcoded URLs and common malware C2 endpoints"
        severity = "medium"
        category = "apk"
    strings:
        $u1 = /https?:\/\/[a-zA-Z0-9\.\-\/_:%?=&#+]+/ ascii
        $u2 = "pastebin.com" ascii
        $u3 = "raw.githubusercontent.com" ascii
        $u4 = "discord.com/api/webhooks" ascii
        $u5 = "api.telegram.org" ascii
        $u6 = "bit.ly" ascii
    condition:
        1 of ($u2, $u3, $u4, $u5, $u6) or $u1
}

rule APK_Crypto_Ransomware_Like {
    meta:
        description = "Java crypto APIs used by Android ransomware"
        severity = "medium"
        category = "apk"
    strings:
        $c1 = "javax.crypto.Cipher" ascii
        $c2 = "Cipher.getInstance" ascii
        $c3 = "SecretKeySpec" ascii
        $c4 = "AES" ascii
        $c5 = "RSA" ascii
    condition:
        2 of them
}

rule APK_Obfuscation_Indicators {
    meta:
        description = "Packed or encrypted Android payload"
        severity = "medium"
        category = "apk"
    strings:
        $dex = "classes.dex" ascii
    condition:
        $dex and math.entropy(0, filesize) > 7.4
}

rule APK_Stealer_Keywords {
    meta:
        description = "Credential / token stealing indicators"
        severity = "high"
        category = "apk"
    strings:
        $s1 = "getText(" ascii
        $s2 = "onTextChanged" ascii
        $s3 = "AccessibilityEvent" ascii
        $s4 = "ClipboardManager" ascii
        $s5 = "getPrimaryClip" ascii
    condition:
        any of them
}
