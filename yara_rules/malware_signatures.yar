*
 * ZeroRisk Sentinel - YARA Rules for Malware Detection
 * These rules detect common malware patterns, suspicious behaviors, and test signatures
 */

rule EICAR_Test_Signature {
    meta:
        description = "EICAR Standard Anti-Virus Test File signature"
        author = "ZeroRisk Sentinel"
        severity = "critical"
        tags = "test, benign"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    condition:
        $eicar
}

rule Suspicious_PE_Extension_Spoofing {
    meta:
        description = "Detects PE files with spoofed extensions (e.g., .pdf.exe)"
        author = "ZeroRisk Sentinel"
        severity = "high"
        tags = "extension_spoofing, social_engineering"
    strings:
        $mz = { 4D 5A }  // MZ header - Windows executable
        $pdf_spoof = ".pdf.exe" nocase
        $doc_spoof = ".doc.exe" nocase
        $docx_spoof = ".docx.exe" nocase
        $jpg_spoof = ".jpg.exe" nocase
        $jpeg_spoof = ".jpeg.exe" nocase
        $png_spoof = ".png.exe" nocase
        $txt_spoof = ".txt.exe" nocase
        $zip_spoof = ".zip.exe" nocase
    condition:
        $mz at 0 and any of ($pdf_spoof, $doc_spoof, $docx_spoof, $jpg_spoof, $jpeg_spoof, $png_spoof, $txt_spoof, $zip_spoof)
}

rule Malicious_Dropper_Patterns {
    meta:
        description = "Detects common dropper and downloader patterns"
        author = "ZeroRisk Sentinel"
        severity = "critical"
        tags = "dropper, downloader, malware"
    strings:
        $url_download = /https?:\/\/[a-zA-Z0-9.-]+\/[a-zA-Z0-9._-]+\.(exe|dll|bat|ps1)/ nocase
        $powershell_download = "powershell" nocase
        $cmd_exec = /cmd\.exe|command\.com/ nocase
        $wscript = "wscript.shell" nocase
        $shell_exec = "shell.execute" nocase
        $create_object = "createobject" nocase
        $reg_write = "regwrite" nocase
        $file_system = "scripting.filesystemobject" nocase
    condition:
        2 of them
}

rule Suspicious_Network_Activity {
    meta:
        description = "Detects network-related suspicious patterns"
        author = "ZeroRisk Sentinel"
        severity = "medium"
        tags = "network, c2, communication"
    strings:
        $socket_create = "socket" nocase
        $http_request = /GET \/|POST \//
        $user_agent = "user-agent" nocase
        $connect = "connect" nocase
        $recv = "recv" nocase
        $send = "send" nocase
        $ws2_32 = "ws2_32.dll" nocase
        $wininet = "wininet.dll" nocase
    condition:
        3 of them
}

rule Process_Injection_Techniques {
    meta:
        description = "Detects process injection related APIs and patterns"
        author = "ZeroRisk Sentinel"
        severity = "critical"
        tags = "injection, process_hollowing, apc"
    strings:
        $virtual_alloc = "virtualallocex" nocase
        $write_process = "writeprocessmemory" nocase
        $create_remote = "createremotethread" nocase
        $nt_unmap = "ntunmapviewofsection" nocase
        $queue_apc = "queueuserapc" nocase
        $resume_thread = "resumethread" nocase
        $open_process = "openprocess" nocase
        $virtual_protect = "virtualprotect" nocase
    condition:
        2 of them
}

rule Ransomware_Indicators {
    meta:
        description = "Detects common ransomware patterns and behaviors"
        author = "ZeroRisk Sentinel"
        severity = "critical"
        tags = "ransomware, encryption, extortion"
    strings:
        $encrypt_ext = /\.(locked|encrypted|crypt|crypto|vault| ransom)/ nocase
        $ransom_note = "ransom" nocase
        $bitcoin = "bitcoin" nocase
        $btc_address = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/
        $tor_url = /[a-z2-7]{16,56}\.onion/
        $your_files = "your files have been encrypted" nocase
        $pay_decrypt = "pay to decrypt" nocase
    condition:
        2 of them
}

rule Keylogger_Patterns {
    meta:
        description = "Detects keylogging related code patterns"
        author = "ZeroRisk Sentinel"
        severity = "high"
        tags = "keylogger, spyware, credential_theft"
    strings:
        $get_async = "getasynckeystate" nocase
        $get_key = "getkeystate" nocase
        $keyboard_hook = "setwindowshookex" nocase
        $wh_keyboard = "wh_keyboard" nocase
        $vk_keys = /VK_[A-Z0-9]+/
        $keylog = "keylog" nocase
        $keystroke = "keystroke" nocase
        $log_keys = "logkeys" nocase
    condition:
        2 of them
}

rule Obfuscation_Techniques {
    meta:
        description = "Detects code obfuscation patterns"
        author = "ZeroRisk Sentinel"
        severity = "medium"
        tags = "obfuscation, evasion, packed"
    strings:
        $base64_pattern = /[A-Za-z0-9+\/]{100,}={0,2}/
        $hex_pattern = /\\x[0-9a-fA-F]{2}/
        $powershell_encoded = "-encodedcommand" nocase
        $bypass_exec = "bypass" nocase
        $hidden_window = "windowstyle hidden" nocase
        $nop_sled = { 90 90 90 90 90 90 90 90 }
    condition:
        2 of them
}

rule Credential_Theft {
    meta:
        description = "Detects credential theft related patterns"
        author = "ZeroRisk Sentinel"
        severity = "critical"
        tags = "credential_theft, password, stealing"
    strings:
        $password = "password" nocase
        $credential = "credential" nocase
        $lsass = "lsass.exe" nocase
        $sam_dump = "\\sam" nocase
        $security_hive = "\\security" nocase
        $mimikatz = "mimikatz" nocase
        $sekurlsa = "sekurlsa" nocase
        $wdigest = "wdigest" nocase
    condition:
        2 of them
}

rule Persistence_Mechanisms {
    meta:
        description = "Detects persistence mechanism patterns"
        author = "ZeroRisk Sentinel"
        severity = "high"
        tags = "persistence, autorun, registry"
    strings:
        $run_key = "\\software\\microsoft\\windows\\currentversion\\run" nocase
        $runonce = "runonce" nocase
        $startup_folder = "\\startup\\" nocase
        $task_scheduler = "schtasks" nocase
        $create_service = "createservice" nocase
        $winlogon = "winlogon" nocase
    condition:
        2 of them
}